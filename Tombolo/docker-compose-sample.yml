services:
  web:
    mem_limit: 1g
    build:
      context: ..
      dockerfile: Tombolo/Dockerfile
      target: client
    networks:
      - tombolo-network
    ports:
      - ${HTTP_PORT}:80
      - ${HTTPS_PORT}:443
    volumes:
      - ${CERT_PATH}:/etc/nginx/certs/
    depends_on:
      node:
        condition: service_healthy
      mysql_db:
        condition: service_healthy
    env_file:
      - .env
    entrypoint: ["sh", "/etc/nginx/run_nginx.sh", "${HOSTNAME}"]
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:80/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  node:
    mem_limit: 3g
    entrypoint: ["sh", "/app/docker-entry.sh", "mysql_db", "3306"]
    build:
      context: ..
      dockerfile: Tombolo/Dockerfile
      target: server
    volumes:
      - /tmp/pm2:/tmp/pm2
      - ./server/cluster-whitelist.js:/app/cluster-whitelist.js
      - ./dockerLogs/server:/app/logs
      - ./certs:/usr/local/share/ca-certificates
      - ./customCerts:/customCerts
      - ./gitClones:/gitClones
    networks:
      - tombolo-network
    ports:
      - ${SERVER_PORT}:${SERVER_PORT}
    depends_on:
      mysql_db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      LOG_DIR: /app/logs/db
      NODE_OPTIONS: --max-old-space-size=2048
    logging:
      driver: "json-file" # Capture container stdout/stderr in JSON files
      options:
        max-size: "2m" # rotate when file reaches 2MB
        max-file: "3" # keep 3 rotated files
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${SERVER_PORT}/api/status/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  jobs:
    mem_limit: 4g
    build:
      context: ..
      dockerfile: Tombolo/Dockerfile
      target: jobs
    volumes:
      - ./dockerLogs/jobs:/app/logs
    networks:
      - tombolo-network
    ports:
      - "8678:8678"
    depends_on:
      mysql_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DB_PORT: 3306 # Override for container-to-container communication
      LOG_DIR: /app/logs
      NODE_OPTIONS: --max-old-space-size=2048
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "3"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8678/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mysql_db:
    mem_limit: 5g
    image: mysql:8.0
    restart: always
    command: >
      --innodb_buffer_pool_size=2560M
      --innodb_log_file_size=512M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT
      --innodb_io_capacity=1000
      --innodb_io_capacity_max=2000
      --innodb_buffer_pool_instances=4
      --innodb_use_native_aio=0
      --sql_mode=""
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./dockerLogs/db:/var/log/mysql
    ports:
      - ${DB_PORT}:3306
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_HOST: ${DB_HOSTNAME}
    networks:
      - tombolo-network
    env_file:
      - .env
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_PASSWORD}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    mem_limit: 512m
    image: redis:8.4-alpine
    restart: always
    networks:
      - tombolo-network
    ports:
      - ${REDIS_PORT}:6379
    env_file:
      - .env
    volumes:
      - ./redis-data:/data
    command: >
      sh -c "
        LIMIT_BYTES=\$(cat /sys/fs/cgroup/memory/memory.limit_in_bytes 2>/dev/null || cat /sys/fs/cgroup/memory.max 2>/dev/null || echo 536870912)
        MAXMEM_BYTES=\$((LIMIT_BYTES - 100 * 1024 * 1024))  # subtract ~100 MiB overhead
        MAXMEM_HUMAN=\$(awk \"BEGIN {printf \\\"%.0fmb\\\", \$MAXMEM_BYTES / 1024 / 1024}\")
        
        if [ -n \"${REDIS_PASSWORD}\" ]; then
          if [ -n \"${REDIS_USER}\" ]; then
            redis-server --requirepass ${REDIS_PASSWORD} --user ${REDIS_USER} on >${REDIS_PASSWORD} ~* &* +@all \
              --maxmemory \$MAXMEM_HUMAN \
              --maxmemory-policy allkeys-lru
          else
            redis-server --requirepass ${REDIS_PASSWORD} \
              --maxmemory \$MAXMEM_HUMAN \
              --maxmemory-policy allkeys-lru
          fi
        else
          redis-server \
            --maxmemory \$MAXMEM_HUMAN \
            --maxmemory-policy allkeys-lru
        fi
      "
    healthcheck:
      test:
        [
          "CMD",
          "sh",
          "-c",
          'if [ -n "${REDIS_PASSWORD}" ]; then redis-cli -a ${REDIS_PASSWORD} ping; else redis-cli ping; fi',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  tombolo-network:
    driver: bridge
